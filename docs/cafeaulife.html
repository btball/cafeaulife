<!DOCTYPE html>  <html> <head>   <title>cafeaulife.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               cafeaulife.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>Cafe au Life</h1>

<p><strong>(c) 2012 Reginald Braithwaite</strong></p>

<p>Cafe au Life is freely distributable under the terms of the
<a href="http://en.wikipedia.org/wiki/MIT_License">MIT license</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Cafe au Life is an implementation of John Conway's <a href="http://en.wikipedia.org/wiki/Conway's_Game_of_Life">Game of Life</a> cellular automata
written in <a href="http://jashkenas.github.com/coffee-script/">CoffeeScript</a>. Cafe au Life runs on <a href="http://nodejs.org">Node.js</a>, it is not designed
to run as an interactive program in a browser window.</p>

<p>Cafe au Life's github project is <a href="https://github.com/raganwald/cafeaulife/">here</a>.</p>

<p><img src="http://raganwald.github.com/cafeaulife/docs/gospers_glider_gun.gif" alt="Gosper's Glider Gun" title="" /></p>

<p><em>(Gosper's Glider Gun. This was the first gun discovered, and proved that Life patterns can grow indefinitely.)</em></p>

<h3>Conway's Life and other two-dimensional cellular automata</h3>

<p>The Life Universe is an infinite two-dimensional matrix of cells. Cells are indivisible and are in either of two states,
commonly called "alive" and "dead." Time is represented as discrete quanta called either "ticks" or "generations."
With each generation, a rule is applied to decide the state the cell will assume. The rules are decided simultaneously,
and there are only two considerations: The current state of the cell, and the states of the cells in its
<a href="http://en.wikipedia.org/wiki/Moore_neighborhood">Moore Neighbourhood</a>, the eight cells adjacent horizontally, vertically, or diagonally.</p>

<p>Cafe au Life implements Conway's Game of Life, as well as other "<a href="http://www.conwaylife.com/wiki/Cellular_automaton#Well-known_Life-like_cellular_automata">life-like</a>" games in the same family.</p>

<h2>Why</h2>

<p><img src="http://raganwald.github.com/cafeaulife/docs/Trueperiod24gun.png" alt="Period 24 Glider Gun" title="" /></p>

<p><em>(A period 24 Glider Gun. Gliders of different periods are useful for synchronizing signals in complex
Life machines.)</em></p>

<p>Cafe au Life is based on Bill Gosper's brilliant <a href="http://en.wikipedia.org/wiki/Hashlife">HashLife</a> algorithm. HashLife is usually implemented in C and optimized
to run very long simulations with very large 'boards' stinking fast. The HashLife algorithm is, in a word,
<strong>a beautiful design</strong>, one that is "in the book." To read its description is to feel the desire to explore it on a computer.</p>

<p>Broadly speaking, HashLife has two major components. The first is a high level algorithm that is implementation independent.
This algorithm exploits repetition and redundancy, aggressively 'caching' previously computed results for regions of the board.
The second component is the cache itself, which is normally implemented cleverly in C to exploit memory and CPU efficiency
in looking up precomputed results.</p>

<p>Cafe au Life is an exercise in exploring the beauty of HashLife's recursive caching or results, while accepting that the
performance in a JavaScript application will not be anything to write home about.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Baseline Setup</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Cafe au Life uses <a href="http://documentcloud.github.com/underscore/">Underscore.js</a> extensively:</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_ = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Play with Node and some browsers</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span> <span class="o">?=</span> <span class="nb">window</span> <span class="o">or</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>A handy function for generating quadrants that are the cartesian products of a collection
multiplied by itself once for each quadrant.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">cartesian_product = </span><span class="nf">(collection) -&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span> <span class="p">{</span><span class="nx">nw</span><span class="p">,</span> <span class="nx">ne</span><span class="p">,</span> <span class="nx">se</span><span class="p">,</span> <span class="nx">sw</span><span class="p">}</span> <span class="k">for</span> <span class="nx">nw</span> <span class="k">in</span> <span class="nx">collection</span> <span class="k">for</span> <span class="nx">ne</span> <span class="k">in</span> <span class="nx">collection</span> <span class="k">for</span> <span class="nx">se</span> <span class="k">in</span> <span class="nx">collection</span> <span class="k">for</span> <span class="nx">sw</span> <span class="k">in</span> <span class="nx">collection</span>
      <span class="p">,</span> <span class="nf">(x, y) -&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">y</span><span class="p">))</span>
    <span class="p">,</span> <span class="nf">(x, y) -&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">y</span><span class="p">))</span>
  <span class="p">,</span> <span class="nf">(x, y) -&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">y</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>A function for turning any array or object into a dictionary function</p>

<p>(see also: <a href="https://github.com/raganwald/homoiconic/blob/master/2012/01/reuseable-abstractions.md#readme">Reusable Abstractions in CoffeeScript</a>)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">dfunc = </span><span class="nf">(dictionary) -&gt;</span>
  <span class="nf">(indices...) -&gt;</span>
    <span class="nx">indices</span><span class="p">.</span><span class="nx">reduce</span> <span class="nf">(a, i) -&gt;</span>
      <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="p">,</span> <span class="nx">dictionary</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h3>Cells</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>The smallest unit of Life is the Cell:</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Cell</span>
  <span class="nv">constructor: </span><span class="nf">(@hash) -&gt;</span>
  <span class="nv">toValue: </span><span class="o">-&gt;</span>
    <span class="nx">@hash</span>
  <span class="nv">to_json: </span><span class="o">-&gt;</span>
    <span class="p">[</span><span class="nx">@hash</span><span class="p">]</span>
  <span class="nv">level: </span><span class="o">-&gt;</span>
    <span class="mi">0</span>
  <span class="nv">empty_copy: </span><span class="o">-&gt;</span>
    <span class="nx">Cell</span><span class="p">.</span><span class="nx">Dead</span>
  <span class="nv">toString: </span><span class="o">-&gt;</span>
    <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nx">@hash</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>The two canonical cells. No more should ever be created. In C++ terms, <code>new</code> is private.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Cell.Alive = </span><span class="k">new</span> <span class="nx">Cell</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nv">Cell.Dead = </span><span class="k">new</span> <span class="nx">Cell</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h3>Squares</h3>

<p><img src="block_laying_seed.png" alt="Block laying seed" title="" /></p>

<p><em>(A small pattern that creates a block-laying switch engine, a "puffer train" that grows forever.)</em></p>

<p>HashLife operates on square regions of the board, with the length of the side of each square being a natural power of two
(<code>2^1 -&gt; 2</code>, <code>2^2 -&gt; 4</code>, <code>2^3 -&gt; 8</code>...). Cells are not considered squares. Therefore, the smallest possible square
(of size <code>2^1</code>) has cells for each of its four quadrants, while all larger squares (of size <code>2^n</code>) have squares of one smaller
size (<code>2^(n-1)</code>) for each of their four quadrants.</p>

<p>For example, a square of size eight (<code>2^3</code>) is composed of four squares of size four (<code>2^2</code>) (The lines and crosses are part of
the quadrant squares):</p>

<pre><code>nw        ne
  +--++--+
  |..||..|
  |..||..|
  +--++--+
  +--++--+
  |..||..|
  |..||..|
  +--++--+
sw        se
</code></pre>

<p>The squares of size four are in turn each composed of four squares of size two (<code>2^1</code>), which are each composed of four cells,
which cannot be subdivided. (For simplicity, a Cafe au Life board is represented as one such large square, although the HashLife
algorithm can be used to handle any board shape by tiling it with squares.)</p>

<h3>Representing squares</h3>

<p>The key principle behind HashLife is taking advantage of redundancy. Therefore, two squares with the same alive and dead cells are always represented by the same, immutable square objects. HashLife exploits repetition and redundancy by making all squares idempotent and unique. In other words, if two squares contain the same sequence of cells, they are represented by the same instance of class <code>Square</code>. For example, there is exactly one representation of a cell of size two containing four empty cells:</p>

<pre><code>nw  ne
  ..
  ..
sw  sw
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>An id for debugging purposes</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">debug_id = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>HashLife represents each unique square as a structure with four quadrants:</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Square</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Squares are constructed from four quadrant squares or cells and store a hash used
to locate the square in the cache</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">({@nw, @ne, @se, @sw}) -&gt;</span>
    <span class="vi">@hash = </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>

    <span class="vi">@debug_id = </span><span class="p">(</span><span class="nx">debug_id</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><code>to_json</code> is a memoized method</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@to_json = </span><span class="nx">_</span><span class="p">.</span><span class="nx">memoize</span><span class="p">(</span> <span class="o">-&gt;</span>
      <span class="nv">a =</span>
        <span class="nv">nw: </span><span class="nx">@nw</span><span class="p">.</span><span class="nx">to_json</span><span class="p">()</span>
        <span class="nv">ne: </span><span class="nx">@ne</span><span class="p">.</span><span class="nx">to_json</span><span class="p">()</span>
        <span class="nv">se: </span><span class="nx">@se</span><span class="p">.</span><span class="nx">to_json</span><span class="p">()</span>
        <span class="nv">sw: </span><span class="nx">@sw</span><span class="p">.</span><span class="nx">to_json</span><span class="p">()</span>
      <span class="nv">b =</span>
        <span class="nv">top: </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">zip</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">nw</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">ne</span><span class="p">),</span> <span class="nf">([left, right]) -&gt;</span>
          <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span>
            <span class="nx">left</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">right</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="p">[</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="nv">bottom: </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">zip</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">sw</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">se</span><span class="p">),</span> <span class="nf">([left, right]) -&gt;</span>
          <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">left</span><span class="p">)</span>
            <span class="nx">left</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">right</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="p">[</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">]</span>
        <span class="p">)</span>
      <span class="nx">b</span><span class="p">.</span><span class="nx">top</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">bottom</span><span class="p">)</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p><code>toString</code> is a memoized method</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@toString = </span><span class="nx">_</span><span class="p">.</span><span class="nx">memoize</span><span class="p">(</span> <span class="o">-&gt;</span>
      <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">@to_json</span><span class="p">(),</span> <span class="nf">(row) -&gt;</span>
        <span class="p">([</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">][</span><span class="nx">c</span><span class="p">]</span> <span class="k">for</span> <span class="nx">c</span> <span class="k">in</span> <span class="nx">row</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The level increases with the log2 of the length of the size.
So level 1 is 2x2, level 2 is 4x4, level 3 is 8x8, and so on.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">level: </span><span class="o">-&gt;</span>
    <span class="nx">@nw</span><span class="p">.</span><span class="nx">level</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Find or create an empty square with the same dimensions</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">empty_copy: </span><span class="o">-&gt;</span>
    <span class="nv">empty_quadrant = </span><span class="nx">@nw</span><span class="p">.</span><span class="nx">empty_copy</span><span class="p">()</span>
    <span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
      <span class="nv">nw: </span><span class="nx">empty_quadrant</span>
      <span class="nv">ne: </span><span class="nx">empty_quadrant</span>
      <span class="nv">se: </span><span class="nx">empty_quadrant</span>
      <span class="nv">sw: </span><span class="nx">empty_quadrant</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Find or create a smaller square centered on this square</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">deflate_by: </span><span class="nf">(extant) -&gt;</span>
    <span class="k">return</span> <span class="k">this</span> <span class="k">if</span> <span class="nx">extant</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">find_or_create_by_quadrant</span><span class="p">(</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span> <span class="p">[</span><span class="mi">0</span><span class="p">..(</span><span class="nx">extant</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)],</span> <span class="nf">(quadrants) -&gt;</span>
        <span class="nv">nw: </span><span class="nx">quadrants</span><span class="p">.</span><span class="nx">nw</span><span class="p">.</span><span class="nx">se</span>
        <span class="nv">ne: </span><span class="nx">quadrants</span><span class="p">.</span><span class="nx">ne</span><span class="p">.</span><span class="nx">sw</span>
        <span class="nv">se: </span><span class="nx">quadrants</span><span class="p">.</span><span class="nx">se</span><span class="p">.</span><span class="nx">nw</span>
        <span class="nv">sw: </span><span class="nx">quadrants</span><span class="p">.</span><span class="nx">sw</span><span class="p">.</span><span class="nx">ne</span>
      <span class="p">,</span> <span class="k">this</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Find or create a larger square centered on this square with
the excess composed of empty squares</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">inflate_by: </span><span class="nf">(extant) -&gt;</span>
    <span class="k">if</span> <span class="nx">extant</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="k">return</span> <span class="k">this</span>
    <span class="k">else</span>
      <span class="nv">empty_quadrant = </span><span class="nx">@nw</span><span class="p">.</span><span class="nx">empty_copy</span><span class="p">()</span>
      <span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span>
        <span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
          <span class="nv">nw: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
            <span class="nv">nw: </span><span class="nx">empty_quadrant</span>
            <span class="nv">ne: </span><span class="nx">empty_quadrant</span>
            <span class="nv">se: </span><span class="nx">@nw</span>
            <span class="nv">sw: </span><span class="nx">empty_quadrant</span>
          <span class="nv">ne: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
            <span class="nv">nw: </span><span class="nx">empty_quadrant</span>
            <span class="nv">ne: </span><span class="nx">empty_quadrant</span>
            <span class="nv">se: </span><span class="nx">empty_quadrant</span>
            <span class="nv">sw: </span><span class="nx">@ne</span>
          <span class="nv">se: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
            <span class="nv">nw: </span><span class="nx">@se</span>
            <span class="nv">ne: </span><span class="nx">empty_quadrant</span>
            <span class="nv">se: </span><span class="nx">empty_quadrant</span>
            <span class="nv">sw: </span><span class="nx">empty_quadrant</span>
          <span class="nv">sw: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
            <span class="nv">nw: </span><span class="nx">empty_quadrant</span>
            <span class="nv">ne: </span><span class="nx">@sw</span>
            <span class="nv">se: </span><span class="nx">empty_quadrant</span>
            <span class="nv">sw: </span><span class="nx">empty_quadrant</span>
        <span class="p">.</span><span class="nx">inflate_by</span><span class="p">(</span><span class="nx">extant</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h3>The Speed of Light</h3>

<p>In Life, the "Speed of Light" or "<em>c</em>" is one cell vertically, horizontally, or diagonally in any direction. Meaning, that cause and effect cannot travel faster than <em>c</em>.</p>

<p>One consequence of this fundamental limit is that given a square of size <code>2^n | n &gt; 1</code> at time <code>t</code>, HashLife has all the information it needs to calculate the alive and dead cells for the inner square of size <code>2^n - 2</code> at time <code>t+1</code>. For example, if HashLife has this square at time <code>t</code>:</p>

<pre><code>nw        ne
  +--++--+
  |..||..|
  |..||..|
  +--++--+
  +--++--+
  |..||..|
  |..||..|
  +--++--+
sw        se
</code></pre>

<p>HashLife can calculate this square at time <code>t+1</code>:</p>

<pre><code>nw        ne

   +----+
   |....|
   |....|
   |....|
   |....|
   +----+

sw        se
</code></pre>

<p>And this square at time <code>t+2</code>:</p>

<pre><code>nw        ne


    +--+
    |..|
    |..|
    +--+


sw        se
</code></pre>

<p>And this square at time <code>t+3</code>:</p>

<pre><code>nw        ne



     ++
     ++



sw        se
</code></pre>

<p>This is because no matter what is in the cells surrounding our square, their effects cannot propagate
faster than the speed of light, one row inward from the edge every step in time.</p>

<p>HashLife takes advantage of this by storing enough information to quickly look up the shrinking
'future' for every square of size <code>2^n | n &gt; 1</code>. The information is called a square's <em>result</em>.</p>

<h2>Computing the result for squares</h2>

<p><img src="block_laying_seed_2.png" alt="Block laying seed" title="" /></p>

<p><em>(Another small pattern that creates a block-laying switch engine, a "puffer train" that grows forever.)</em></p>

<p>Let's revisit the obvious: Cells do not have results. Also, Squares ofsize two do not have results,
because at time <code>t+1</code>, cells outside of the square will affect every cell in the square.</p>

<p>The smallest square that computes a result is of size four (<code>2^2</code>). Its result is a square of
size two (<code>2^1</code>) representing the state of those cells at time <code>t+1</code>:</p>

<pre><code>....
.++.
.++.
....
</code></pre>

<p>The computation of the four inner <code>+</code> cells from their adjacent eight cells is straightforward and
is calculated from the basic 2-3 rules or looked up from a table with 65K entries.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h3>Seeding Cafe au Life with squares of size four</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p><code>generate_seeds_from_rule</code> generates the size four "seed" squares that actually calculate their results
from the life-like game rules. All larger squares decompose recursively into size four squares, and thus
do not need to know anything about the rules.</p>

<p>The default, <code>generate_seeds_from_rule()</code>, is equivalent to <code>generate_seeds_from_rule([2,3],[3])</code>, which
invokes Conway's Game of Life, commonly written as 23/3. Other games can be invoked with their survival
and birth counts, e.g. <code>generate_seeds_from_rule([1,3,5,7], [1,3,5,7])</code> invokes
<a href="http://www.conwaylife.com/wiki/Replicator_(CA">Replicator</a>)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span> <span class="nx">exports</span><span class="p">,</span>
  <span class="nv">generate_seeds_from_rule: </span><span class="nf">(survival = [2,3], birth = [3]) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Bail if we are given the same rules and already have generated the expected number of seeds</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">current_rules</span> <span class="k">if</span> <span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">current_rules</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">is</span> <span class="p">{</span><span class="nx">survival</span><span class="p">,</span> <span class="nx">birth</span><span class="p">}.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">and</span> <span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">bucketed</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">65552</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>The rules expressed as a dictionary function</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">rule = </span><span class="nx">dfunc</span> <span class="p">[</span>
      <span class="p">(</span><span class="k">if</span> <span class="nx">birth</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">Cell</span><span class="p">.</span><span class="nx">Alive</span> <span class="k">else</span> <span class="nx">Cell</span><span class="p">.</span><span class="nx">Dead</span><span class="p">)</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">9</span><span class="p">]</span>
      <span class="p">(</span><span class="k">if</span> <span class="nx">survival</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">Cell</span><span class="p">.</span><span class="nx">Alive</span> <span class="k">else</span> <span class="nx">Cell</span><span class="p">.</span><span class="nx">Dead</span><span class="p">)</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">9</span><span class="p">]</span>
    <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>successfor function for any cell</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">succ = </span><span class="nf">(cells, row, col) -&gt;</span>
      <span class="nv">current_state = </span><span class="nx">cells</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span>
      <span class="nv">neighbour_count = </span><span class="nx">cells</span><span class="p">[</span><span class="nx">row</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="nx">col</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">cells</span><span class="p">[</span><span class="nx">row</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span> <span class="o">+</span>
        <span class="nx">cells</span><span class="p">[</span><span class="nx">row</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="nx">col</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">cells</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
        <span class="nx">cells</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">cells</span><span class="p">[</span><span class="nx">row</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="nx">col</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
        <span class="nx">cells</span><span class="p">[</span><span class="nx">row</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span> <span class="o">+</span> <span class="nx">cells</span><span class="p">[</span><span class="nx">row</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="nx">col</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
      <span class="nx">rule</span><span class="p">(</span><span class="nx">current_state</span><span class="p">,</span> <span class="nx">neighbour_count</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>A SeedSquare knows how to calculate its own result from
the rules</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">class</span> <span class="nx">SeedSquare</span> <span class="k">extends</span> <span class="nx">Square</span>
      <span class="nv">constructor: </span><span class="nf">(params) -&gt;</span>
        <span class="k">super</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Seed squares compute a result one generation into the future. (We will see later that
larger squares results more generations into the future.)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="vi">@generations = </span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p><code>result</code> calculates the inner result square. The method
is memoized.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="vi">@result = </span><span class="nx">_</span><span class="p">.</span><span class="nx">memoize</span><span class="p">(</span>
          <span class="o">-&gt;</span>
            <span class="nv">a = </span><span class="nx">@to_json</span><span class="p">()</span>
            <span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">find</span>
              <span class="nv">nw: </span><span class="nx">succ</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
              <span class="nv">ne: </span><span class="nx">succ</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
              <span class="nv">se: </span><span class="nx">succ</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
              <span class="nv">sw: </span><span class="nx">succ</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Clear the cache out</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>The canonical 2x2 squares are initialized from the cartesian product
of every possible cell. 2 possible cells to the power of 4 quadrants gives sixteen
possible 2x2 squares.</p>

<p>2x2 squares do not compute results</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">all_2x2_squares = </span><span class="nx">cartesian_product</span><span class="p">([</span><span class="nx">Cell</span><span class="p">.</span><span class="nx">Dead</span><span class="p">,</span> <span class="nx">Cell</span><span class="p">.</span><span class="nx">Alive</span><span class="p">]).</span><span class="nx">map</span> <span class="nf">(quadrants) -&gt;</span>
      <span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Square</span><span class="p">(</span><span class="nx">quadrants</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>The canonical 4x4 squares are initialized from the cartesian product of
every possible 2x2 square. 16 possible 2x2 squares to the power of 4 quadrants
gives 65,536 possible 4x4 squares.</p>

<p>4x4 squares know how to compute their 2x2 results, and as we saw above, they
memoize those results so that they are only computed once. (A variation of
memoizing the result computation is to compute it when generating the 4x4 square,
thus "compiling" the supplied rules into a table of 65,536 rules taht is looked
up at runtime.)</p>

<p>We will see below that all larger squares compute their results by recursively
combining the results of smaller squares, so therefore all such computations
will terminate when they reach a square of size 4x4.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">cartesian_product</span><span class="p">(</span><span class="nx">all_2x2_squares</span><span class="p">).</span><span class="nx">forEach</span> <span class="nf">(quadrants) -&gt;</span>
      <span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">SeedSquare</span><span class="p">(</span><span class="nx">quadrants</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Put the rules in the cache and return them.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">Square.cache.current_rules = </span><span class="p">{</span><span class="nx">survival</span><span class="p">,</span> <span class="nx">birth</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <hr />

<h2>Recursively constructing squares of size eight (and larger)</h2>

<p><img src="LWSS.gif" alt="Lightweight Spaceship" title="" /></p>

<p><em>(A small pattern that moves.)</em></p>

<p>Now let's consider a square of size eight. For the moment, we can ignore the question of what happens
when a square is not in the cache, because when dealing with squares of size eight, we only ever need
to look up squares of size four, and they are all seeded in the cache. (Once we have established how
to construct the result for a square of size eight, including its result and velocity, we will be able
to write out <code>.find</code> method to handle looking up squares of size eight and dealing with cache 'misses'
by constructing a new square.)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Our class will be a <code>RecursivelyComputableSquare</code>. We'll isolate helpers:</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">RecursivelyComputableSquare = </span><span class="nx">do</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>We know how to obtain any square of size four using <code>cache.find</code>. So what we need is a way to compute
the result for any arbitrary square of size eight or larger from quadrant squares one level smaller.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Our goal is to compute a result that looks like this (the lines and crosses are part of the result):</p>

<pre><code>nw        ne

    +--+
    |..|
    |..|
    +--+

sw        se
</code></pre>

<p>Given that we know the result for each of those four squares, we can start building an intermediate result.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>The class for intermediate results:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">class</span> <span class="nx">IntermediateResult</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>We construct an intermediate result from a square of size eight or larger</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">constructor: </span><span class="nf">(square) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>For convenience, we'll use Underscore's <code>extend</code> rather than a lot of assignments
to @nw, @se, et cetera.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="k">this</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>First, Let's look at our square of size eight made up of four component squares of size four (the lines
and crosses are part of the components):</p>

<pre><code>nw        ne
  +--++--+
  |..||..|
  |..||..|
  +--++--+
  +--++--+
  |..||..|
  |..||..|
  +--++--+
sw        se
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>We can take the results of those four quadrants and add them to our intermediate square</p>

<pre><code>nw        ne

   nw..ne
   nw..ne
   ......
   ......
   sw..se
   sw..se

sw        se
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">nw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">nw</span><span class="p">.</span><span class="nx">result</span><span class="p">()</span>
        <span class="nv">ne: </span><span class="nx">square</span><span class="p">.</span><span class="nx">ne</span><span class="p">.</span><span class="nx">result</span><span class="p">()</span>
        <span class="nv">se: </span><span class="nx">square</span><span class="p">.</span><span class="nx">se</span><span class="p">.</span><span class="nx">result</span><span class="p">()</span>
        <span class="nv">sw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">sw</span><span class="p">.</span><span class="nx">result</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>We can also derive four overlapping squares, these representing <code>n</code>, <code>e</code>, <code>s</code>, and <code>w</code>:</p>

<pre><code>     nn
  ..+--+..        ..+--+..
  ..|..|..        ..|..|..
  +-|..|-+        +--++--+
  |.+--+.|      w |..||..| e
  |.+--+.|      w |..||..| e
  +-|..|-+        +--++--+
  ..|..|..        ..|..|..
  ..+--+..        ..+--+..
     ss
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Deriving these from our four component squares is straightforward, and when we take their results,
we fill in four of the five missing blanks for our intermediate square:</p>

<pre><code>nw        ne

   ..nn..
   ..nn..
   ww..ee
   ww..ee
   ..ss..
   ..ss..

sw        se
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">nn: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span>
          <span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
            <span class="nv">nw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">nw</span><span class="p">.</span><span class="nx">ne</span>
            <span class="nv">ne: </span><span class="nx">square</span><span class="p">.</span><span class="nx">ne</span><span class="p">.</span><span class="nx">nw</span>
            <span class="nv">se: </span><span class="nx">square</span><span class="p">.</span><span class="nx">ne</span><span class="p">.</span><span class="nx">sw</span>
            <span class="nv">sw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">nw</span><span class="p">.</span><span class="nx">se</span>
          <span class="p">.</span><span class="nx">result</span><span class="p">()</span>
        <span class="nv">ee: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span>
          <span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
            <span class="nv">nw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">ne</span><span class="p">.</span><span class="nx">sw</span>
            <span class="nv">ne: </span><span class="nx">square</span><span class="p">.</span><span class="nx">ne</span><span class="p">.</span><span class="nx">se</span>
            <span class="nv">se: </span><span class="nx">square</span><span class="p">.</span><span class="nx">se</span><span class="p">.</span><span class="nx">ne</span>
            <span class="nv">sw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">se</span><span class="p">.</span><span class="nx">nw</span>
          <span class="p">.</span><span class="nx">result</span><span class="p">()</span>
        <span class="nv">ss: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span>
          <span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
            <span class="nv">nw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">sw</span><span class="p">.</span><span class="nx">ne</span>
            <span class="nv">ne: </span><span class="nx">square</span><span class="p">.</span><span class="nx">se</span><span class="p">.</span><span class="nx">nw</span>
            <span class="nv">se: </span><span class="nx">square</span><span class="p">.</span><span class="nx">se</span><span class="p">.</span><span class="nx">sw</span>
            <span class="nv">sw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">sw</span><span class="p">.</span><span class="nx">se</span>
          <span class="p">.</span><span class="nx">result</span><span class="p">()</span>
        <span class="nv">ww: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span>
          <span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
            <span class="nv">nw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">nw</span><span class="p">.</span><span class="nx">sw</span>
            <span class="nv">ne: </span><span class="nx">square</span><span class="p">.</span><span class="nx">nw</span><span class="p">.</span><span class="nx">se</span>
            <span class="nv">se: </span><span class="nx">square</span><span class="p">.</span><span class="nx">sw</span><span class="p">.</span><span class="nx">ne</span>
            <span class="nv">sw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">sw</span><span class="p">.</span><span class="nx">nw</span>
          <span class="p">.</span><span class="nx">result</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>We use a similar method to derive a center square:</p>

<pre><code>nw        ne

   ......
   .+--+.
   .|..|.
   .|..|.
   .+--+.
   ......

sw        se
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>And we extract its result square accordingly:</p>

<pre><code>nw        ne

   ......
   ......
   ..cc..
   ..cc..
   ......
   ......

sw        se
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">cc: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span>
          <span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
            <span class="nv">nw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">nw</span><span class="p">.</span><span class="nx">se</span>
            <span class="nv">ne: </span><span class="nx">square</span><span class="p">.</span><span class="nx">ne</span><span class="p">.</span><span class="nx">sw</span>
            <span class="nv">se: </span><span class="nx">square</span><span class="p">.</span><span class="nx">se</span><span class="p">.</span><span class="nx">nw</span>
            <span class="nv">sw: </span><span class="nx">square</span><span class="p">.</span><span class="nx">sw</span><span class="p">.</span><span class="nx">ne</span>
          <span class="p">.</span><span class="nx">result</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>We have now derived nine squares of size <code>2^(n-1)</code>: Four component squares and five we have
derived from second-order components. The results we have extracted have all been cached, so
we are performing lookups rather than computations.</p>

<p>These squares fit together to make a larger intermediate square, one that does not neatly fit
into our world of <code>2^n</code> quanta:</p>

<pre><code>nw        ne

   nwnnne
   nwnnne
   wwccee
   wwccee
   swssse
   swssse

sw        se
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <h3>Obtaining a result from the intermediate square</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">result: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>From our nine squares, we can make four <em>overlapping</em> squares of size <code>2^(n-1)</code>:</p>

<pre><code>nw        ne  nw        ne

   nwnn..        ..nnne
   nwnn..        ..nnne
   wwcc..        ..ccee
   wwcc..        ..ccee
   ......        ......
   ......        ......

sw        se  sw        se

nw        ne  nw        ne

   ......        ......
   ......        ......
   wwcc..        ..ccee
   wwcc..        ..ccee
   swss..        ..ssse
   swss..        ..ssse

sw        se  sw        se
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">overlapping_squares =</span>
        <span class="nv">nw: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span>
          <span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
            <span class="nv">nw: </span><span class="nx">@nw</span>
            <span class="nv">ne: </span><span class="nx">@nn</span>
            <span class="nv">se: </span><span class="nx">@cc</span>
            <span class="nv">sw: </span><span class="nx">@ww</span>
        <span class="nv">ne: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span>
          <span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
            <span class="nv">nw: </span><span class="nx">@nn</span>
            <span class="nv">ne: </span><span class="nx">@ne</span>
            <span class="nv">se: </span><span class="nx">@ee</span>
            <span class="nv">sw: </span><span class="nx">@cc</span>
        <span class="nv">se: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span>
          <span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
            <span class="nv">nw: </span><span class="nx">@cc</span>
            <span class="nv">ne: </span><span class="nx">@ee</span>
            <span class="nv">se: </span><span class="nx">@se</span>
            <span class="nv">sw: </span><span class="nx">@ss</span>
        <span class="nv">sw: </span><span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span>
          <span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
            <span class="nv">nw: </span><span class="nx">@ww</span>
            <span class="nv">ne: </span><span class="nx">@cc</span>
            <span class="nv">se: </span><span class="nx">@ss</span>
            <span class="nv">sw: </span><span class="nx">@sw</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>We can now make a square from the results from each of those quadrants:</p>

<pre><code>nw        ne

   ......
   .nwne.
   .nwne.
   .swse.
   .swse.
   ......

sw        se
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">Square</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">find_or_create_by_quadrant</span>
        <span class="nv">nw: </span><span class="nx">overlapping_squares</span><span class="p">.</span><span class="nx">nw</span><span class="p">.</span><span class="nx">result</span><span class="p">()</span>
        <span class="nv">ne: </span><span class="nx">overlapping_squares</span><span class="p">.</span><span class="nx">ne</span><span class="p">.</span><span class="nx">result</span><span class="p">()</span>
        <span class="nv">se: </span><span class="nx">overlapping_squares</span><span class="p">.</span><span class="nx">se</span><span class="p">.</span><span class="nx">result</span><span class="p">()</span>
        <span class="nv">sw: </span><span class="nx">overlapping_squares</span><span class="p">.</span><span class="nx">sw</span><span class="p">.</span><span class="nx">result</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>A <code>RecursivelyComputableSquare</code> is a square of size eight or larger</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">class</span> <span class="nx">RecursivelyComputableSquare</span> <span class="k">extends</span> <span class="nx">Square</span>
    <span class="nv">constructor: </span><span class="nf">(quadrants) -&gt;</span>
      <span class="k">super</span><span class="p">(</span><span class="nx">quadrants</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>When we fit the results of an intermediate square within our original square
of size eight, we reveal we have a square of size four, <code>2^(n-1)</code> as we wanted</p>

<pre><code>nw        ne
  ........
  ........
  ..nwne..
  ..nwne..
  ..swse..
  ..swse..
  ........
  ........
sw        se
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@result = </span><span class="nx">_</span><span class="p">.</span><span class="nx">memoize</span><span class="p">(</span> <span class="o">-&gt;</span>
        <span class="k">new</span> <span class="nx">IntermediateResult</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">result</span><span class="p">()</span>
      <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>The number of generation is double the number of generations of any of its quadrants</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@generations = </span><span class="nx">@nw</span><span class="p">.</span><span class="nx">generations</span> <span class="o">*</span> <span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <h3>Memoizing: The "Hash" in HashLife</h3>

<p>HashLife gets a tremendous speed-up by storing and reusing squares in a giant cache.
Any result, at any scale, that has been computed before is reused. This is extremely
efficient when dealing with patterns that contain a great deal of redundancy, such as
the kinds of patterns constructed for the purpose of emulating circuits or machines in Life.</p>

<p>Once Cafe au Life has calculated the results for the 65K possible four-by-four
squares, the rules are no longer applied to any generation: Any pattern of any size is
recursively computed terminating in a four-by-four square that has already been computed and cached.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Square.cache =</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>chosen from http://primes.utm.edu/lists/small/10000.txt. Probably should be > 65K</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">num_buckets: </span><span class="mi">99991</span>
  <span class="nv">buckets: </span><span class="p">[]</span>

  <span class="nv">clear: </span><span class="o">-&gt;</span>
    <span class="vi">@buckets = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p><code>hash</code> returns an integer for any square</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">hash: </span><span class="nf">(square_like) -&gt;</span>
    <span class="k">if</span> <span class="nx">square_like</span><span class="p">.</span><span class="nx">hash</span><span class="o">?</span>
      <span class="nx">square_like</span><span class="p">.</span><span class="nx">hash</span>
    <span class="k">else</span>
      <span class="p">((</span><span class="mi">3</span> <span class="o">*</span><span class="nx">@hash</span><span class="p">(</span><span class="nx">square_like</span><span class="p">.</span><span class="nx">nw</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">37</span> <span class="o">*</span> <span class="nx">@hash</span><span class="p">(</span><span class="nx">square_like</span><span class="p">.</span><span class="nx">ne</span><span class="p">))</span>  <span class="o">+</span> <span class="p">(</span><span class="mi">79</span> <span class="o">*</span> <span class="nx">@hash</span><span class="p">(</span><span class="nx">square_like</span><span class="p">.</span><span class="nx">se</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">131</span> <span class="o">*</span> <span class="nx">@hash</span><span class="p">(</span><span class="nx">square_like</span><span class="p">.</span><span class="nx">sw</span><span class="p">)))</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p><code>find</code> locates a square in the cache if it exists</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">find: </span><span class="nf">(quadrants) -&gt;</span>
    <span class="nv">bucket_number = </span><span class="nx">@hash</span><span class="p">(</span><span class="nx">quadrants</span><span class="p">)</span> <span class="o">%</span> <span class="nx">@num_buckets</span>
    <span class="k">if</span> <span class="nx">@buckets</span><span class="p">[</span><span class="nx">bucket_number</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">@buckets</span><span class="p">[</span><span class="nx">bucket_number</span><span class="p">],</span> <span class="nf">(sq) -&gt;</span>
        <span class="nx">sq</span><span class="p">.</span><span class="nx">nw</span> <span class="o">is</span> <span class="nx">quadrants</span><span class="p">.</span><span class="nx">nw</span> <span class="o">and</span> <span class="nx">sq</span><span class="p">.</span><span class="nx">ne</span> <span class="o">is</span> <span class="nx">quadrants</span><span class="p">.</span><span class="nx">ne</span> <span class="o">and</span> <span class="nx">sq</span><span class="p">.</span><span class="nx">se</span> <span class="o">is</span> <span class="nx">quadrants</span><span class="p">.</span><span class="nx">se</span> <span class="o">and</span> <span class="nx">sq</span><span class="p">.</span><span class="nx">sw</span> <span class="o">is</span> <span class="nx">quadrants</span><span class="p">.</span><span class="nx">sw</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p><code>Like find</code>, but creates a <code>RecursivelyComputableSquare</code> if none is found</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">find_or_create_by_quadrant: </span><span class="nf">(quadrants) -&gt;</span>
    <span class="nv">found = </span><span class="nx">@find</span><span class="p">(</span><span class="nx">quadrants</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">found</span>
      <span class="nx">found</span>
    <span class="k">else</span>
      <span class="nx">@add</span><span class="p">(</span><span class="k">new</span> <span class="nx">RecursivelyComputableSquare</span><span class="p">(</span><span class="nx">quadrants</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p><code>Like find_or_create_by_quadrant</code>, but takes json as an argument. Useful
for seeding the world from a data file.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">find_or_create_by_json: </span><span class="nf">(json) -&gt;</span>
    <span class="nx">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">json</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">and</span> <span class="nx">json</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">json</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">throw</span> <span class="s1">&#39;must be a square&#39;</span>
    <span class="k">if</span> <span class="nx">json</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="nx">json</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">Cell</span>
        <span class="nx">json</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">json</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="nx">Cell</span><span class="p">.</span><span class="nx">Dead</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">json</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="mi">1</span>
        <span class="nx">Cell</span><span class="p">.</span><span class="nx">Alive</span>
      <span class="k">else</span>
        <span class="k">throw</span> <span class="s1">&#39;a 1x1 square must contain a zero, one, or Cell&#39;</span>
    <span class="k">else</span>
      <span class="nv">half_length = </span><span class="nx">json</span><span class="p">.</span><span class="nx">length</span> <span class="err">/ 2</span>
      <span class="nx">@find_or_create_by_quadrant</span>
        <span class="nv">nw: </span><span class="nx">@find_or_create_by_json</span><span class="p">(</span>
          <span class="nx">json</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">half_length</span><span class="p">).</span><span class="nx">map</span> <span class="nf">(row) -&gt;</span>
            <span class="nx">row</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">half_length</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nv">ne: </span><span class="nx">@find_or_create_by_json</span><span class="p">(</span>
          <span class="nx">json</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">half_length</span><span class="p">).</span><span class="nx">map</span> <span class="nf">(row) -&gt;</span>
            <span class="nx">row</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">half_length</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nv">se: </span><span class="nx">@find_or_create_by_json</span><span class="p">(</span>
          <span class="nx">json</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">half_length</span><span class="p">).</span><span class="nx">map</span> <span class="nf">(row) -&gt;</span>
            <span class="nx">row</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">half_length</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nv">sw: </span><span class="nx">@find_or_create_by_json</span><span class="p">(</span>
          <span class="nx">json</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">half_length</span><span class="p">).</span><span class="nx">map</span> <span class="nf">(row) -&gt;</span>
            <span class="nx">row</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">half_length</span><span class="p">)</span>
        <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>An agnostic method that can find or create anything</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">find_or_create: </span><span class="nf">(params) -&gt;</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
      <span class="nx">@find_or_create_by_json</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span> <span class="p">[</span><span class="s1">&#39;nw&#39;</span><span class="p">,</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span> <span class="s1">&#39;se&#39;</span><span class="p">,</span> <span class="s1">&#39;sw&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nf">(quadrant) -&gt;</span> <span class="nx">params</span><span class="p">[</span><span class="nx">quadrant</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">Cell</span><span class="p">)</span> <span class="p">)</span>
      <span class="nx">@find_or_create_by_quadrant</span> <span class="nx">params</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span> <span class="p">[</span><span class="s1">&#39;nw&#39;</span><span class="p">,</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span> <span class="s1">&#39;se&#39;</span><span class="p">,</span> <span class="s1">&#39;sw&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nf">(quadrant) -&gt;</span> <span class="nx">params</span><span class="p">[</span><span class="nx">quadrant</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">Square</span><span class="p">)</span> <span class="p">)</span>
      <span class="nx">@find_or_create_by_quadrant</span> <span class="nx">params</span>
    <span class="k">else</span>
      <span class="k">throw</span> <span class="s2">&quot;Cache can&#39;t handle #{JSON.stringify(params)}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>adds a square to the cache if it doesn't already exist</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">add: </span><span class="nf">(square) -&gt;</span>
    <span class="nv">bucket_number = </span><span class="nx">square</span><span class="p">.</span><span class="nx">hash</span> <span class="o">%</span> <span class="nx">@num_buckets</span>
    <span class="nx">@buckets</span><span class="p">[</span><span class="nx">bucket_number</span><span class="p">]</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="nx">@buckets</span><span class="p">[</span><span class="nx">bucket_number</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">@buckets</span><span class="p">[</span><span class="nx">bucket_number</span><span class="p">],</span> <span class="nf">(found) -&gt;</span>
      <span class="nx">found</span><span class="p">.</span><span class="nx">nw</span> <span class="o">is</span> <span class="nx">square</span><span class="p">.</span><span class="nx">nw</span> <span class="o">and</span> <span class="nx">found</span><span class="p">.</span><span class="nx">ne</span> <span class="o">is</span> <span class="nx">square</span><span class="p">.</span><span class="nx">ne</span> <span class="o">and</span> <span class="nx">found</span><span class="p">.</span><span class="nx">se</span> <span class="o">is</span> <span class="nx">square</span><span class="p">.</span><span class="nx">se</span> <span class="o">and</span> <span class="nx">found</span><span class="p">.</span><span class="nx">sw</span> <span class="o">is</span> <span class="nx">square</span><span class="p">.</span><span class="nx">sw</span>
    <span class="nx">@buckets</span><span class="p">[</span><span class="nx">bucket_number</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">square</span><span class="p">)</span>
    <span class="nx">square</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>For debugging, it can be useful to count the number of squares in the cache</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bucketed: </span><span class="o">-&gt;</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span> <span class="nx">@buckets</span><span class="p">,</span> <span class="nf">(sum, bucket) -&gt;</span>
      <span class="nx">sum</span> <span class="o">+</span> <span class="nx">bucket</span><span class="p">.</span><span class="nx">length</span>
    <span class="p">,</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>For debugging, it can be useful to get an idea of the relative sizes of the cache buckets</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">histogram: </span><span class="o">-&gt;</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span> <span class="nx">@buckets</span><span class="p">,</span> <span class="nf">(histo, bucket) -&gt;</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">tap</span> <span class="nx">histo</span><span class="p">,</span> <span class="nf">(h) -&gt;</span>
        <span class="nx">h</span><span class="p">[</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">||=</span> <span class="mi">0</span>
        <span class="nx">h</span><span class="p">[</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="p">,</span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Expose <code>find_or_create</code> through <code>Square</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Square.find_or_create = </span><span class="nf">(params) -&gt;</span>
  <span class="nx">@cache</span><span class="p">.</span><span class="nx">find_or_create</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Export <code>Square</code> and <code>Cell</code> for regular use and specs</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span> <span class="nx">exports</span><span class="p">,</span> <span class="p">{</span><span class="nx">Square</span><span class="p">,</span> <span class="nx">Cell</span><span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 